#!/usr/bin/env bash

if [[ ! $# -eq 1 ]] ; then
    echo "Usage: $0 <pr-number>"
    exit 1
fi

if [[ ! $1 =~ ^[1-9][0-9]*$ ]] ; then
    echo "Invalid pull request number \"$1\""
    exit 1
fi

source .env.dist
if [[ -f .env ]] ; then
    source .env
fi

PR=$1
URL="https://api.github.com/repos/msgphp/msgphp/pulls/$PR"
if [[ ! -z "$GITHUB_TOKEN" ]] ; then
    URL="$URL?access_token=$GITHUB_TOKEN"
fi

BODY=$(curl -sS -w ">>>%{http_code}" $URL)

if [[ ! $BODY =~ \>\>\>200\s*$ ]] ; then
    echo -e "\e[34mError fetching pull request #$PR...\e[0m"
    echo $BODY
    exit 1
fi

BODY=$(echo $BODY | sed -e "s/>>>200$//" -e "s/\\\/\\\\\\\/g")

UPSTREAM_SSH_URL=$(php -r "echo (@json_decode(trim(<<<EOL
$BODY
EOL
), true) ?: [])['head']['repo']['ssh_url'] ?? '';")
UPSTREAM_BRANCH=$(php -r "echo (@json_decode(trim(<<<EOL
$BODY
EOL
), true) ?: [])['head']['ref'] ?? '';")

if [[ -z "$UPSTREAM_SSH_URL" ]] ; then
    echo "Upstream SSH URL not found for pull request \"$URL\""
    exit 1
fi

if [[ ! -z "$(git status --porcelain)" ]] ; then
    echo "Current working must be clean to continue..."
    exit 1
fi

UPSTREAM_REMOTE="pr-$PR"

git remote add $UPSTREAM_REMOTE $UPSTREAM_SSH_URL &> /dev/null
git fetch $UPSTREAM_REMOTE
git branch -Df $UPSTREAM_REMOTE &> /dev/null
git checkout -b $UPSTREAM_REMOTE $UPSTREAM_REMOTE/$UPSTREAM_BRANCH
git pull
